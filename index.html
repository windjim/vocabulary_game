<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CNN Vocabulary Game â€“ L1~L13 (Offline)</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        body {
            background: #0b1229;
            color: #f5f6ff;
            font-family: 'Noto Sans TC', system-ui, -apple-system, 'Segoe UI', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .card {
            background: #141a3d;
            padding: 20px;
            border-radius: 20px;
            max-width: 1100px;
            width: 100%;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
        }

        h2 {
            margin-top: 0;
        }

        button {
            background: #3556f0;
            color: #fff;
            border: none;
            padding: 7px 14px;
            border-radius: 8px;
            cursor: pointer;
            margin: 2px 2px;
            font-size: 13px;
        }

        button.ghost {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, .2);
        }

        button:disabled {
            opacity: .5;
            cursor: not-allowed;
        }

        .units {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 6px;
        }

        .units label {
            background: rgba(0, 0, 0, .12);
            padding: 3px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
        }

        .units input {
            margin-right: 3px;
        }

        #opts {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .opt {
            background: #1e2750;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            border: 1px solid transparent;
        }

        .opt:hover {
            background: #273068;
        }

        .opt.correct {
            background: #1aa471;
            border-color: rgba(255, 255, 255, .2);
        }

        .opt.wrong {
            background: #a33f52;
            border-color: rgba(255, 255, 255, .2);
        }

        .badge {
            display: inline-block;
            background: rgba(255, 255, 255, .08);
            padding: 2px 9px 3px;
            border-radius: 999px;
            font-size: 12px;
            margin-right: 4px;
        }

        #exampleBox {
            background: rgba(0, 0, 0, .15);
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 10px;
            padding: 8px 10px;
            margin-top: 10px;
            display: none;
            font-size: 13px;
            white-space: pre-wrap;
        }

        .small-muted {
            font-size: 11px;
            color: rgba(255, 255, 255, .6);
        }

        /* Checkbox å®¹å™¨æ¨£å¼ */
        #unitCheckboxContainer {
            display: none;
            background: #1e2750;
            border: 1px solid rgba(255, 255, 255, .2);
            border-radius: 8px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
            min-width: 280px;
            max-width: 400px;
        }

        #unitCheckboxContainer label {
            display: flex;
            align-items: center;
            padding: 6px 8px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }

        #unitCheckboxContainer label:hover {
            background: rgba(255, 255, 255, .05);
        }

        #unitCheckboxContainer input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
            width: 16px;
            height: 16px;
        }

        @media(max-width:720px) {
            #opts {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="card">
        <h2>ğŸ“˜ CNN Vocabulary Game </h2>

        <!-- å–®å…ƒé¸æ“‡å€åŸŸ -->
        <div style="margin-bottom:10px;">
            <label style="margin-right:8px;font-size:14px;">é¸æ“‡å–®å…ƒï¼š</label>

            <!-- å–®é¸æ¨¡å¼ï¼šä¸‹æ‹‰é¸å–® -->
            <select id="unitSelect"
                style="background:#1e2750;color:#f5f6ff;border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:8px 10px;min-width:280px;max-width:400px;font-size:13px;outline:none;box-shadow:0 2px 8px rgba(0,0,0,.15);">
                <option disabled style="color:#888;">è«‹å…ˆä¸Šå‚³ Excel æª”æ¡ˆ</option>
            </select>

            <!-- å¤šé¸æ¨¡å¼ï¼šCheckbox åˆ—è¡¨ -->
            <div id="unitCheckboxContainer">
                <div style="color:#888;font-size:13px;">è«‹å…ˆä¸Šå‚³ Excel æª”æ¡ˆ</div>
            </div>
        </div>

        <div style="margin:6px 0 10px;">
            <label style="margin-right:8px;font-size:14px;">å‡ºé¡Œæ¨¡å¼ï¼š</label>
            <button id="singleMode" class="ghost">å–®é¸æ¨¡å¼</button>
            <button id="multiMode" class="ghost">å¤šé¸æ¨¡å¼</button>
            <button id="mixMode" class="ghost">æ··åˆå‡ºé¡Œ</button>
            <button id="uncertainMode" class="ghost">åªå‡ºä¸ç¢ºå®š
                <span class="badge" style="background:rgba(255,165,0,.15);">ç¸½å…±ä¸ç¢ºå®šæ•¸é‡: <span id="uncertainCount">0</span>
                </span>
            </button>
        </div>
        <div style="margin:6px 0 10px;" id="multiModeControls" style="display:none;">
            <button id="all" class="ghost">å…¨é¸</button>
            <button id="none" class="ghost">å…¨ä¸é¸</button>
        </div>
        <div style="margin-bottom:8px;">
            <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none;" />
            <button id="uploadBtn" class="ghost">ğŸ“¤ ä¸Šå‚³ Excel</button>
            <span id="uploadStatus" style="font-size:12px;margin-left:8px;color:#4ade80;"></span>
        </div>
        <div style="margin-bottom:8px;">
            <button id="start">é–‹å§‹å‡ºé¡Œ</button>
            <button id="next" disabled>ä¸‹ä¸€é¡Œ</button>
            <button id="restart" class="ghost" disabled>é‡æ–°æ¸¬è©¦</button>
            <button id="reset" class="ghost">é‡ç½®çµ±è¨ˆ</button>
        </div>
        <p>
            <span class="badge">å¾—åˆ† <span id="score">0</span></span>
            <span class="badge">é¡Œæ•¸ <span id="count">0</span></span>
            <span class="badge">æ­£ç¢ºç‡ <span id="acc">0%</span></span>
        </p>
        <hr />
        <h3 id="word">â€”</h3>
        <p id="pos" class="small-muted"></p>
        <div id="opts"></div>
        <button id="notSureBtn" class="ghost" style="margin-top:8px;">ä¸ç¢ºå®š / é¡¯ç¤ºä¾‹å¥</button>
        <div id="exampleBox"></div>
        <p id="info" class="small-muted" style="margin-top:10px;"></p>
    </div>

    <script>
        // --------------------------------------------------
        // é¡Œåº«ï¼šL1~L13
        // L1~L6 é€™è£¡æˆ‘å…ˆæ”¾ç¤ºç¯„å¹¾ç­†ï¼ŒL7~L13 æ˜¯ä½ å‰›å‰›æä¾›çš„æ­£å¼è³‡æ–™
        // ä¹‹å¾Œä½ è¦è£œ L1~L6 çœŸè³‡æ–™ï¼Œåªè¦å¾€é€™å€‹é™£åˆ—ç¹¼çºŒåŠ å°±å¥½
        // --------------------------------------------------
        // å¾ localStorage è¼‰å…¥ DATA
        let DATA = [];
        try {
            const savedData = localStorage.getItem('vocabularyData');
            if (savedData) {
                DATA = JSON.parse(savedData);
                console.log(`å·²å¾ localStorage è¼‰å…¥ ${DATA.length} å€‹å–®å­—`);
            }
        } catch (error) {
            console.error('è¼‰å…¥ localStorage è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            DATA = [];
        }

        // --------------------------------------------------
        // Excel ä¸Šå‚³èˆ‡è§£æåŠŸèƒ½
        // --------------------------------------------------
        const uploadBtn = document.getElementById('uploadBtn');
        const excelFile = document.getElementById('excelFile');
        const uploadStatus = document.getElementById('uploadStatus');

        uploadBtn.addEventListener('click', () => {
            excelFile.click();
        });

        excelFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            uploadStatus.textContent = 'è§£æä¸­...';
            uploadStatus.style.color = '#fbbf24';

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // é©—è­‰ä¸¦è½‰æ›è³‡æ–™æ ¼å¼
                    let addedCount = 0;
                    let totalProcessed = 0;
                    const newUnits = new Set();
                    const sheetsProcessed = [];

                    // è®€å–æ‰€æœ‰å·¥ä½œè¡¨
                    workbook.SheetNames.forEach((sheetName) => {
                        const worksheet = workbook.Sheets[sheetName];

                        // è½‰æ›ç‚º JSON
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);

                        if (jsonData.length === 0) {
                            console.warn(`é ç±¤ã€Œ${sheetName}ã€ä¸­æ²’æœ‰è³‡æ–™ï¼Œå·²ç•¥é`);
                            return;
                        }

                        let sheetAddedCount = 0;

                        jsonData.forEach((row, index) => {
                            totalProcessed++;

                            // é©—è­‰å¿…å¡«æ¬„ä½ï¼ˆåªéœ€è¦ã€Œå–®å­—ã€å’Œã€Œæ„æ€ã€ï¼‰
                            if (!row['å–®å­—'] || !row['æ„æ€']) {
                                console.warn(`é ç±¤ã€Œ${sheetName}ã€ç¬¬ ${index + 2} åˆ—è³‡æ–™ä¸å®Œæ•´ï¼Œå·²ç•¥é`, row);
                                return;
                            }

                            // ä½¿ç”¨é ç±¤åç¨±ä½œç‚º unit
                            const unit = sheetName;

                            // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå–®å­—ï¼ˆä½¿ç”¨ç¹é«”ä¸­æ–‡æ¨™é¡Œï¼‰
                            const word = row['å–®å­—'];

                            const isDuplicate = DATA.some(item =>
                                item.unit === unit && item.word.toLowerCase() === word.toLowerCase()
                            );


                            if (!isDuplicate) {
                                DATA.push({
                                    unit: unit,
                                    word: row['å–®å­—'],
                                    pos: row['è©æ€§'] || '',
                                    chinese: row['æ„æ€'],
                                    example: row['ä¾‹å¥'] || ''
                                });
                                addedCount++;
                                sheetAddedCount++;
                                newUnits.add(unit);
                            }
                        });

                        if (sheetAddedCount > 0) {
                            sheetsProcessed.push(`${sheetName}(${sheetAddedCount})`);
                        }
                    });

                    if (addedCount === 0 && totalProcessed === 0) {
                        throw new Error('Excel æª”æ¡ˆä¸­æ²’æœ‰è³‡æ–™');
                    }

                    // æ›´æ–°å–®å…ƒé¸æ“‡æ¸…å–®
                    if (newUnits.size > 0) {
                        updateUnitList(newUnits);
                    }

                    // å„²å­˜åˆ° localStorage
                    try {
                        localStorage.setItem('vocabularyData', JSON.stringify(DATA));
                        console.log('å·²å°‡è³‡æ–™å„²å­˜åˆ° localStorage');
                    } catch (error) {
                        console.error('å„²å­˜åˆ° localStorage æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                        alert('è­¦å‘Šï¼šç„¡æ³•å„²å­˜è³‡æ–™åˆ° localStorageï¼Œå¯èƒ½æ˜¯å› ç‚ºå„²å­˜ç©ºé–“å·²æ»¿');
                    }

                    // é¡¯ç¤ºè©³ç´°çš„æˆåŠŸè¨Šæ¯
                    let message = `âœ“ æˆåŠŸåŠ å…¥ ${addedCount} å€‹å–®å­—`;
                    if (sheetsProcessed.length > 0) {
                        message += ` [${sheetsProcessed.join(', ')}]`;
                    }
                    uploadStatus.textContent = message;
                    uploadStatus.style.color = '#4ade80';

                    // åœ¨ console é¡¯ç¤ºæ›´è©³ç´°çš„è³‡è¨Š
                    console.log(`å·²è™•ç† ${workbook.SheetNames.length} å€‹é ç±¤ï¼ŒæˆåŠŸåŠ å…¥ ${addedCount} å€‹å–®å­—`);
                    console.log('è™•ç†çš„é ç±¤:', sheetsProcessed);

                    // 5 ç§’å¾Œæ¸…é™¤ç‹€æ…‹ï¼ˆå› ç‚ºè¨Šæ¯è¼ƒé•·ï¼Œå¤šçµ¦ä¸€é»æ™‚é–“é–±è®€ï¼‰
                    setTimeout(() => {
                        uploadStatus.textContent = '';
                    }, 5000);

                } catch (error) {
                    uploadStatus.textContent = `âœ— éŒ¯èª¤: ${error.message}`;
                    uploadStatus.style.color = '#f87171';
                    console.error('è§£æ Excel æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                }
            };

            reader.onerror = () => {
                uploadStatus.textContent = 'âœ— è®€å–æª”æ¡ˆå¤±æ•—';
                uploadStatus.style.color = '#f87171';
            };

            reader.readAsArrayBuffer(file);

            // æ¸…é™¤ inputï¼Œå…è¨±é‡è¤‡ä¸Šå‚³åŒä¸€å€‹æª”æ¡ˆ
            e.target.value = '';
        });

        // æ›´æ–°å–®å…ƒé¸æ“‡æ¸…å–®ï¼ˆæ”¯æ´ä¸‹æ‹‰é¸å–®å’Œ checkboxï¼‰
        function updateUnitList(newUnits) {
            const unitSelect = document.getElementById('unitSelect');
            const checkboxContainer = document.getElementById('unitCheckboxContainer');

            // ç²å–ç¾æœ‰çš„ unit å€¼ï¼ˆå¾ä¸‹æ‹‰é¸å–®ï¼‰
            const existingUnits = Array.from(unitSelect.options)
                .filter(opt => !opt.disabled)
                .map(opt => opt.value);

            // æ¸…é™¤æç¤ºè¨Šæ¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (unitSelect.options.length > 0 && unitSelect.options[0].disabled) {
                unitSelect.remove(0);
            }

            // æ”¶é›†æ‰€æœ‰ unitï¼ˆç¾æœ‰çš„ + æ–°çš„ï¼‰
            const allUnits = new Set([...existingUnits, ...newUnits]);

            // å°‡ Set è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº
            const sortedUnits = Array.from(allUnits).sort((a, b) => {
                // å˜—è©¦æå–æ•¸å­—é€²è¡Œæ’åºï¼ˆä¾‹å¦‚ L1, L2, L10ï¼‰
                const numA = parseInt(a.replace(/\D/g, '')) || 0;
                const numB = parseInt(b.replace(/\D/g, '')) || 0;
                if (numA !== numB) return numA - numB;
                return a.localeCompare(b);
            });

            // æ›´æ–°ä¸‹æ‹‰é¸å–®
            unitSelect.innerHTML = '';
            sortedUnits.forEach((unit, index) => {
                const option = document.createElement('option');
                option.value = unit;
                option.textContent = unit;
                option.selected = index === 0; // å–®é¸æ¨¡å¼é è¨­é¸ç¬¬ä¸€å€‹
                unitSelect.appendChild(option);
            });

            // æ›´æ–° checkbox å®¹å™¨
            checkboxContainer.innerHTML = '';
            sortedUnits.forEach((unit) => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = unit;
                checkbox.checked = true; // å¤šé¸æ¨¡å¼é è¨­å…¨é¸

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(unit));
                checkboxContainer.appendChild(label);
            });
        }

        // --------------------------------------------------
        // éŠæˆ²ç‹€æ…‹ç®¡ç†
        // --------------------------------------------------
        let score = 0;          // å¾—åˆ†
        let total = 0;          // ç¸½é¡Œæ•¸
        let currentQ = null;    // ç•¶å‰é¡Œç›®
        let pool = [];          // é¡Œåº«æ± 
        let remainingPool = []; // å‰©é¤˜æœªå‡ºé¡Œçš„é¡Œåº«

        // å¾ localStorage è¼‰å…¥ä¸ç¢ºå®šçš„å–®å­—é›†åˆ
        let uncertainSet = new Set();
        try {
            const savedUncertain = localStorage.getItem('uncertainWords');
            if (savedUncertain) {
                uncertainSet = new Set(JSON.parse(savedUncertain));
                console.log(`å·²å¾ localStorage è¼‰å…¥ ${uncertainSet.size} å€‹ä¸ç¢ºå®šå–®å­—`);
            }
        } catch (error) {
            console.error('è¼‰å…¥ä¸ç¢ºå®šå–®å­—æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            uncertainSet = new Set();
        }

        let currentMode = 'multi';  // ç•¶å‰æ¨¡å¼ï¼š'single', 'multi', 'mix', 'uncertain'
        let lastSelectedUnits = []; // è¨˜éŒ„ä¸Šæ¬¡é¸æ“‡çš„å–®å…ƒ

        // æ›´æ–°æ¨¡å¼æŒ‰éˆ•ç‹€æ…‹ï¼ˆçµ±ä¸€ç®¡ç†å››ç¨®æ¨¡å¼ï¼‰
        function updateModeButtons(mode) {
            const singleBtn = document.getElementById('singleMode');
            const multiBtn = document.getElementById('multiMode');
            const mixBtn = document.getElementById('mixMode');
            const uncertainBtn = document.getElementById('uncertainMode');
            const unitSelect = document.getElementById('unitSelect');
            const checkboxContainer = document.getElementById('unitCheckboxContainer');
            const multiModeControls = document.getElementById('multiModeControls');

            // é‡ç½®æ‰€æœ‰æŒ‰éˆ•
            [singleBtn, multiBtn, mixBtn, uncertainBtn].forEach(btn => {
                btn.style.background = 'transparent';
            });

            // è¨­ç½®ç•¶å‰æ¨¡å¼
            currentMode = mode;

            switch (mode) {
                case 'single':
                    // å–®é¸æ¨¡å¼ï¼šä¸‹æ‹‰é¸å–®
                    singleBtn.style.background = '#3556f0';
                    unitSelect.style.display = 'block';
                    checkboxContainer.style.display = 'none';
                    multiModeControls.style.display = 'none';

                    // åŒæ­¥ checkbox åˆ°ä¸‹æ‹‰é¸å–®
                    const checkboxes = checkboxContainer.querySelectorAll('input[type="checkbox"]:checked');
                    if (checkboxes.length > 0) {
                        const firstUnit = checkboxes[0].value;
                        Array.from(unitSelect.options).forEach(opt => {
                            opt.selected = opt.value === firstUnit;
                        });
                    } else if (unitSelect.options.length > 0 && !unitSelect.options[0].disabled) {
                        unitSelect.options[0].selected = true;
                    }
                    break;

                case 'multi':
                    // å¤šé¸æ¨¡å¼ï¼šcheckbox
                    multiBtn.style.background = '#3556f0';
                    unitSelect.style.display = 'none';
                    checkboxContainer.style.display = 'block';
                    multiModeControls.style.display = 'block';

                    // åŒæ­¥ä¸‹æ‹‰é¸å–®åˆ° checkbox
                    const selectedValue = Array.from(unitSelect.options).find(opt => opt.selected)?.value;
                    const allCheckboxes = checkboxContainer.querySelectorAll('input[type="checkbox"]');
                    allCheckboxes.forEach(cb => {
                        if (selectedValue) {
                            cb.checked = cb.value === selectedValue;
                        }
                    });
                    break;

                case 'mix':
                    // æ··åˆå‡ºé¡Œæ¨¡å¼ï¼šcheckboxï¼ˆå¯å¤šé¸ï¼Œéš¨æ©Ÿå‡ºé¡Œï¼‰
                    mixBtn.style.background = '#3556f0';
                    unitSelect.style.display = 'none';
                    checkboxContainer.style.display = 'block';
                    multiModeControls.style.display = 'block';
                    break;

                case 'uncertain':
                    // åªå‡ºä¸ç¢ºå®šæ¨¡å¼ï¼šéš±è—å–®å…ƒé¸æ“‡
                    uncertainBtn.style.background = '#3556f0';
                    unitSelect.style.display = 'none';
                    checkboxContainer.style.display = 'none';
                    multiModeControls.style.display = 'none';
                    break;
            }
        }

        // å–®é¸æ¨¡å¼
        document.getElementById('singleMode')?.addEventListener('click', () => {
            updateModeButtons('single');
        });

        // å¤šé¸æ¨¡å¼
        document.getElementById('multiMode')?.addEventListener('click', () => {
            updateModeButtons('multi');
        });

        // æ··åˆå‡ºé¡Œæ¨¡å¼
        document.getElementById('mixMode')?.addEventListener('click', () => {
            updateModeButtons('mix');
        });

        // åªå‡ºä¸ç¢ºå®šæ¨¡å¼
        document.getElementById('uncertainMode')?.addEventListener('click', () => {
            if (uncertainSet.size === 0) {
                alert('ç›®å‰æ²’æœ‰æ¨™è¨˜ç‚ºã€Œä¸ç¢ºå®šã€çš„å–®å­—');
                return;
            }
            updateModeButtons('uncertain');
        });

        // å…¨é¸åŠŸèƒ½
        document.getElementById('all')?.addEventListener('click', () => {
            const checkboxContainer = document.getElementById('unitCheckboxContainer');
            const checkboxes = checkboxContainer.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
        });

        // å…¨ä¸é¸åŠŸèƒ½
        document.getElementById('none')?.addEventListener('click', () => {
            const checkboxContainer = document.getElementById('unitCheckboxContainer');
            const checkboxes = checkboxContainer.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = false);
        });

        // åˆå§‹åŒ–ç‚ºå¤šé¸æ¨¡å¼
        updateModeButtons('single');

        // ç²å–é¸ä¸­çš„å–®å…ƒ
        function getSelectedUnits() {
            const unitSelect = document.getElementById('unitSelect');
            const checkboxContainer = document.getElementById('unitCheckboxContainer');

            switch (currentMode) {
                case 'single':
                    // å–®é¸æ¨¡å¼ï¼šå¾ä¸‹æ‹‰é¸å–®ç²å–
                    const selected = Array.from(unitSelect.options).find(opt => opt.selected);
                    return selected ? [selected.value] : [];

                case 'multi':
                case 'mix':
                    // å¤šé¸æ¨¡å¼æˆ–æ··åˆæ¨¡å¼ï¼šå¾ checkbox ç²å–
                    const checkboxes = checkboxContainer.querySelectorAll('input[type="checkbox"]:checked');
                    return Array.from(checkboxes).map(cb => cb.value);

                case 'uncertain':
                    // åªå‡ºä¸ç¢ºå®šæ¨¡å¼ï¼šè¿”å›ç©ºé™£åˆ—ï¼ˆä¸éœ€è¦å–®å…ƒé¸æ“‡ï¼‰
                    return [];

                default:
                    return [];
            }
        }

        // æ›´æ–°çµ±è¨ˆé¡¯ç¤º
        function updateStats() {
            document.getElementById('score').textContent = score;
            document.getElementById('count').textContent = total;
            const acc = total === 0 ? 0 : Math.round((score / total) * 100);
            document.getElementById('acc').textContent = acc + '%';
            document.getElementById('uncertainCount').textContent = uncertainSet.size;
        }

        // éš¨æ©Ÿæ‰“äº‚é™£åˆ—
        function shuffle(arr) {
            const copy = [...arr];
            for (let i = copy.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [copy[i], copy[j]] = [copy[j], copy[i]];
            }
            return copy;
        }

        // ç”Ÿæˆé¡Œç›®
        function generateQuestion() {
            // æª¢æŸ¥æ˜¯å¦é‚„æœ‰å‰©é¤˜é¡Œç›®
            if (remainingPool.length === 0) {
                alert(`æ‰€æœ‰é¡Œç›®å·²å®Œæˆï¼\nç¸½é¡Œæ•¸ï¼š${total}\nç­”å°ï¼š${score}\næ­£ç¢ºç‡ï¼š${total === 0 ? 0 : Math.round((score / total) * 100)}%`);
                document.getElementById('next').disabled = true;
                return;
            }

            // å¾å‰©é¤˜é¡Œåº«ä¸­éš¨æ©Ÿé¸ä¸€å€‹å–®å­—
            const randomIndex = Math.floor(Math.random() * remainingPool.length);
            const correctItem = remainingPool[randomIndex];

            // å¾å‰©é¤˜é¡Œåº«ä¸­ç§»é™¤å·²é¸æ“‡çš„å–®å­—
            remainingPool.splice(randomIndex, 1);

            // æº–å‚™é¸é …ï¼šæ­£ç¢ºç­”æ¡ˆ + 3å€‹éŒ¯èª¤ç­”æ¡ˆï¼ˆå¾å®Œæ•´é¡Œåº«ä¸­é¸æ“‡ï¼‰
            const wrongPool = pool.filter(item => item.chinese !== correctItem.chinese);
            if (wrongPool.length < 3) {
                alert('é¡Œåº«é¸é …ä¸è¶³ï¼ˆè‡³å°‘éœ€è¦4å€‹ä¸åŒçš„å–®å­—ï¼‰');
                return;
            }

            const wrongItems = shuffle(wrongPool).slice(0, 3);
            const options = shuffle([correctItem, ...wrongItems]);

            // è¨­ç½®é¡Œç›®
            currentQ = {
                correct: correctItem,
                options: options
            };

            // é¡¯ç¤ºé¡Œç›®
            document.getElementById('word').textContent = correctItem.word;
            document.getElementById('pos').textContent = correctItem.pos || '';

            // é¡¯ç¤ºå‰©é¤˜é¡Œæ•¸
            document.getElementById('info').textContent = `å‰©é¤˜é¡Œæ•¸ï¼š${remainingPool.length}`;
            document.getElementById('info').style.color = '#888';

            // æ¸…ç©ºä¸¦ç”Ÿæˆé¸é …æŒ‰éˆ•
            const optsDiv = document.getElementById('opts');
            optsDiv.innerHTML = '';

            options.forEach((opt, index) => {
                const btn = document.createElement('div');
                btn.className = 'opt';
                btn.textContent = opt.chinese;
                btn.addEventListener('click', () => checkAnswer(opt, btn));
                optsDiv.appendChild(btn);
            });

            // éš±è—ä¾‹å¥
            document.getElementById('exampleBox').style.display = 'none';

            // å•Ÿç”¨ã€Œä¸ç¢ºå®šã€æŒ‰éˆ•
            document.getElementById('notSureBtn').disabled = false;
        }

        // æª¢æŸ¥ç­”æ¡ˆ
        function checkAnswer(selected, btn) {
            if (!currentQ) return;

            // ç¦ç”¨æ‰€æœ‰é¸é …æŒ‰éˆ•
            const allOpts = document.querySelectorAll('.opt');
            allOpts.forEach(opt => {
                opt.style.pointerEvents = 'none';
            });

            total++;

            if (selected.chinese === currentQ.correct.chinese) {
                // ç­”å°
                btn.classList.add('correct');
                score++;
                document.getElementById('info').textContent = 'âœ“ æ­£ç¢ºï¼';
                document.getElementById('info').style.color = '#4ade80';
            } else {
                // ç­”éŒ¯
                btn.classList.add('wrong');
                document.getElementById('info').textContent = 'âœ— éŒ¯èª¤ï¼Œæ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š' + currentQ.correct.chinese;
                document.getElementById('info').style.color = '#f87171';

                // æ¨™ç¤ºæ­£ç¢ºç­”æ¡ˆ
                allOpts.forEach(opt => {
                    if (opt.textContent === currentQ.correct.chinese) {
                        opt.classList.add('correct');
                    }
                });
            }

            // å¦‚æœæœ‰ä¾‹å¥ï¼Œè‡ªå‹•é¡¯ç¤º
            if (currentQ.correct.example) {
                document.getElementById('exampleBox').textContent = currentQ.correct.example;
                document.getElementById('exampleBox').style.display = 'block';
            }

            updateStats();

            // å•Ÿç”¨ã€Œä¸‹ä¸€é¡Œã€æŒ‰éˆ•
            document.getElementById('next').disabled = false;
            document.getElementById('notSureBtn').disabled = true;
        }

        // é–‹å§‹éŠæˆ²çš„å…±ç”¨é‚è¼¯
        function startGame(selectedUnits) {
            if (DATA.length === 0) {
                alert('è«‹å…ˆä¸Šå‚³ Excel æª”æ¡ˆ');
                return false;
            }

            // æ ¹æ“šæ¨¡å¼ç¯©é¸é¡Œåº«
            if (currentMode === 'uncertain') {
                // åªå‡ºä¸ç¢ºå®šçš„å–®å­—
                if (uncertainSet.size === 0) {
                    alert('ç›®å‰æ²’æœ‰æ¨™è¨˜ç‚ºã€Œä¸ç¢ºå®šã€çš„å–®å­—');
                    return false;
                }
                pool = DATA.filter(item => uncertainSet.has(item.word));
            } else {
                // å…¶ä»–æ¨¡å¼ï¼šæ ¹æ“šé¸ä¸­çš„å–®å…ƒç¯©é¸
                if (selectedUnits.length === 0) {
                    alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å–®å…ƒ');
                    return false;
                }
                pool = DATA.filter(item => selectedUnits.includes(item.unit));
            }

            if (pool.length === 0) {
                alert('æ‰€é¸å–®å…ƒæ²’æœ‰å–®å­—è³‡æ–™');
                return false;
            }

            // æª¢æŸ¥é¡Œåº«æ˜¯å¦è¶³å¤ ï¼ˆè‡³å°‘éœ€è¦4å€‹ä¸åŒçš„å–®å­—ï¼‰
            if (pool.length < 2) {
                alert('é¡Œåº«å–®å­—ä¸è¶³ï¼Œè‡³å°‘éœ€è¦4å€‹ä¸åŒçš„å–®å­—æ‰èƒ½é–‹å§‹éŠæˆ²');
                return false;
            }

            // åˆå§‹åŒ–å‰©é¤˜é¡Œåº«ï¼ˆè¤‡è£½ä¸€ä»½å®Œæ•´é¡Œåº«ï¼‰
            remainingPool = [...pool];

            // æ··åˆå‡ºé¡Œæ¨¡å¼ï¼šæ‰“äº‚å‰©é¤˜é¡Œåº«é †åº
            if (currentMode === 'mix') {
                remainingPool = shuffle(remainingPool);
            }

            // é‡ç½®çµ±è¨ˆï¼ˆåŒ…å«ä¸ç¢ºå®šå–®å­—é›†åˆï¼‰
            score = 0;
            total = 0;
            uncertainSet.clear();  // åªæ¸…ç©ºç•¶å‰æ¸¬è©¦çš„é›†åˆï¼Œä¸æ¸…é™¤ localStorage

            // è¨˜éŒ„ç•¶å‰é¸æ“‡çš„å–®å…ƒ
            lastSelectedUnits = selectedUnits;

            updateStats();
            generateQuestion();

            document.getElementById('next').disabled = false;
            document.getElementById('restart').disabled = false;

            return true;
        }

        // é–‹å§‹å‡ºé¡Œ
        document.getElementById('start')?.addEventListener('click', () => {
            const selectedUnits = getSelectedUnits();
            startGame(selectedUnits);
        });

        // ä¸‹ä¸€é¡Œ
        document.getElementById('next')?.addEventListener('click', () => {
            generateQuestion();
            document.getElementById('next').disabled = true;
        });

        // é‡æ–°æ¸¬è©¦
        document.getElementById('restart')?.addEventListener('click', () => {
            if (lastSelectedUnits.length === 0) {
                alert('è«‹å…ˆé–‹å§‹å‡ºé¡Œ');
                return;
            }

            // ä½¿ç”¨ä¸Šæ¬¡é¸æ“‡çš„å–®å…ƒé‡æ–°é–‹å§‹
            startGame(lastSelectedUnits);
        });

        // ä¸ç¢ºå®š / é¡¯ç¤ºä¾‹å¥
        document.getElementById('notSureBtn')?.addEventListener('click', () => {
            if (!currentQ) return;

            const savedUncertain = localStorage.getItem('uncertainWords');
            if (savedUncertain) {
                uncertainSet = new Set(JSON.parse(savedUncertain));
            }

            // åŠ å…¥ä¸ç¢ºå®šé›†åˆ
            uncertainSet.add(currentQ.correct.word);
            updateStats();

            // å„²å­˜åˆ° localStorage
            try {
                localStorage.setItem('uncertainWords', JSON.stringify([...uncertainSet]));
            } catch (error) {
                console.error('å„²å­˜ä¸ç¢ºå®šå–®å­—åˆ° localStorage æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }

            // é¡¯ç¤ºä¾‹å¥
            if (currentQ.correct.example) {
                document.getElementById('exampleBox').textContent = currentQ.correct.example;
                document.getElementById('exampleBox').style.display = 'block';
            } else {
                document.getElementById('exampleBox').textContent = 'ï¼ˆç„¡ä¾‹å¥ï¼‰';
                document.getElementById('exampleBox').style.display = 'block';
            }

            document.getElementById('info').textContent = 'å·²æ¨™è¨˜ç‚ºã€Œä¸ç¢ºå®šã€';
            document.getElementById('info').style.color = '#fbbf24';
        });

        // é‡ç½®çµ±è¨ˆ
        document.getElementById('reset')?.addEventListener('click', () => {
            if (confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰çµ±è¨ˆè³‡æ–™å—ï¼Ÿ')) {
                score = 0;
                total = 0;
                uncertainSet.clear();
                updateStats();

                // æ¸…é™¤ localStorage ä¸­çš„ä¸ç¢ºå®šå–®å­—
                try {
                    localStorage.removeItem('uncertainWords');
                    console.log('å·²æ¸…é™¤ localStorage ä¸­çš„ä¸ç¢ºå®šå–®å­—');
                } catch (error) {
                    console.error('æ¸…é™¤ä¸ç¢ºå®šå–®å­—æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                }

                document.getElementById('word').textContent = 'â€”';
                document.getElementById('pos').textContent = '';
                document.getElementById('opts').innerHTML = '';
                document.getElementById('exampleBox').style.display = 'none';
                document.getElementById('info').textContent = '';
                document.getElementById('next').disabled = true;
                document.getElementById('restart').disabled = true;
            }
        });

        // åˆå§‹åŒ–çµ±è¨ˆ
        updateStats();

        // é é¢è¼‰å…¥æ™‚ï¼Œå¦‚æœ localStorage ä¸­æœ‰è³‡æ–™ï¼Œè‡ªå‹•æ¢å¾©å–®å…ƒåˆ—è¡¨
        if (DATA.length > 0) {
            const allUnits = new Set();
            DATA.forEach(item => {
                if (item.unit) {
                    allUnits.add(item.unit);
                }
            });

            if (allUnits.size > 0) {
                updateUnitList(allUnits);
                console.log(`å·²æ¢å¾© ${allUnits.size} å€‹å–®å…ƒ`);
            }
        }
    </script>
</body>

</html>